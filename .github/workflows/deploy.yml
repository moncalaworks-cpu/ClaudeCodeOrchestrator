name: Deploy to Heroku

on:
  repository_dispatch:
    types: [deployment-approved]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          DEPLOYMENT_ID: ${{ github.event.client_payload.deployment_id }}
          APPROVER: ${{ github.event.client_payload.approver }}
        run: |
          echo "üöÄ Deploying $DEPLOYMENT_ID (approved by $APPROVER)..."
          git config user.email "orchestrator@heroku.local"
          git config user.name "Claude Orchestrator"
          git remote add heroku https://git.heroku.com/claude-code-orchestrator.git
          git push https://oauth2:${HEROKU_API_KEY}@git.heroku.com/claude-code-orchestrator.git HEAD:main
          echo "‚úÖ Deployment to Heroku completed!"

      - name: Update Notion - Mark as Deployed
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          DEPLOYMENT_ID: ${{ github.event.client_payload.deployment_id }}
        run: |
          # Install jq for JSON parsing
          sudo apt-get update > /dev/null && sudo apt-get install -y jq > /dev/null

          # Find the deployment record and update status to Deployed
          echo "üìù Updating Notion: $DEPLOYMENT_ID -> Deployed"
          echo "Database ID: $NOTION_DATABASE_ID"

          # Query Notion database for the deployment record
          QUERY_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query \
            -H "Authorization: Bearer $NOTION_API_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{
              "filter": {
                "property": "Deployment ID",
                "text": {
                  "contains": "'$DEPLOYMENT_ID'"
                }
              }
            }')

          echo "Full query response:"
          echo "$QUERY_RESPONSE"

          # Extract HTTP status
          HTTP_STATUS=$(echo "$QUERY_RESPONSE" | tail -n1 | cut -d':' -f2)
          RESPONSE_BODY=$(echo "$QUERY_RESPONSE" | head -n-1)

          echo "HTTP Status: $HTTP_STATUS"

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå Notion API error (HTTP $HTTP_STATUS)"
            exit 0
          fi

          # Extract the page ID from the first result
          PAGE_ID=$(echo "$RESPONSE_BODY" | jq -r '.results[0].id' 2>/dev/null)

          if [ -z "$PAGE_ID" ] || [ "$PAGE_ID" = "null" ]; then
            echo "‚ö†Ô∏è Deployment record not found in Notion"
            echo "Checking results count:"
            echo "$RESPONSE_BODY" | jq '.results | length'
            exit 0
          fi

          echo "‚úÖ Found page ID: $PAGE_ID"

          # Update the page with Deployed status
          UPDATE_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X PATCH https://api.notion.com/v1/pages/$PAGE_ID \
            -H "Authorization: Bearer $NOTION_API_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d '{
              "properties": {
                "Current Stage": {
                  "select": {
                    "name": "Deployed"
                  }
                },
                "Deployment Status": {
                  "select": {
                    "name": "Success"
                  }
                }
              }
            }')

          echo "Update response:"
          echo "$UPDATE_RESPONSE"
          echo "‚úÖ Notion update complete"
