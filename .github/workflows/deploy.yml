name: Deploy to Heroku

on:
  repository_dispatch:
    types: [deployment-approved]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          DEPLOYMENT_ID: ${{ github.event.client_payload.deployment_id }}
          APPROVER: ${{ github.event.client_payload.approver }}
        run: |
          echo "üöÄ Deploying $DEPLOYMENT_ID (approved by $APPROVER)..."
          git config user.email "orchestrator@heroku.local"
          git config user.name "Claude Orchestrator"
          git remote add heroku https://git.heroku.com/claude-code-orchestrator.git
          git push https://oauth2:${HEROKU_API_KEY}@git.heroku.com/claude-code-orchestrator.git HEAD:main
          echo "‚úÖ Deployment to Heroku completed!"

      - name: Update Notion - Mark as Deployed
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          DEPLOYMENT_ID: ${{ github.event.client_payload.deployment_id }}
        run: |
          set +e  # Disable exit on error so we can see error messages

          # Install jq for JSON parsing
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq

          # Trim whitespace from secrets
          NOTION_DATABASE_ID=$(echo "$NOTION_DATABASE_ID" | xargs)
          NOTION_API_TOKEN=$(echo "$NOTION_API_TOKEN" | xargs)

          # Find the deployment record and update status to Deployed
          echo "üìù Updating Notion: $DEPLOYMENT_ID -> Deployed"
          echo "Database ID length: ${#NOTION_DATABASE_ID}"
          echo "Database ID (first 8 chars): ${NOTION_DATABASE_ID:0:8}..."

          if [ -z "$NOTION_DATABASE_ID" ]; then
            echo "‚ùå ERROR: NOTION_DATABASE_ID is empty!"
            exit 1
          fi

          # Create JSON filter payload
          FILTER_JSON=$(cat <<EOF
          {
            "filter": {
              "property": "Deployment ID",
              "text": {
                "contains": "$DEPLOYMENT_ID"
              }
            }
          }
          EOF
          )

          echo "Query filter: $FILTER_JSON"

          # Query Notion database
          API_URL="https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query"
          echo "Querying Notion API..."
          echo "API URL: $API_URL"
          QUERY_RESPONSE=$(curl -s -X POST "$API_URL" \
            -H "Authorization: Bearer $NOTION_API_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d "$FILTER_JSON")

          echo "Full query response:"
          echo "$QUERY_RESPONSE" | jq '.'

          # Extract the page ID
          PAGE_ID=$(echo "$QUERY_RESPONSE" | jq -r '.results[0].id // empty')

          if [ -z "$PAGE_ID" ]; then
            echo "‚ö†Ô∏è Deployment record not found"
            echo "Results count: $(echo "$QUERY_RESPONSE" | jq '.results | length')"
            exit 0
          fi

          echo "‚úÖ Found page ID: $PAGE_ID"

          # Create update payload
          UPDATE_JSON=$(cat <<EOF
          {
            "properties": {
              "Current Stage": {
                "select": {
                  "name": "Deployed"
                }
              },
              "Deployment Status": {
                "select": {
                  "name": "Success"
                }
              }
            }
          }
          EOF
          )

          # Update the page
          PATCH_URL="https://api.notion.com/v1/pages/$PAGE_ID"
          echo "Updating Notion page..."
          echo "Patch URL: $PATCH_URL"
          UPDATE_RESPONSE=$(curl -s -X PATCH "$PATCH_URL" \
            -H "Authorization: Bearer $NOTION_API_TOKEN" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            -d "$UPDATE_JSON")

          echo "Update response:"
          echo "$UPDATE_RESPONSE" | jq '.'
          echo "‚úÖ Notion update complete"
